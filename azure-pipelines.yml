# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- staging

pool:
  name: Testing Environment Agent Pool

variables:
  AgentPool: "Testing Environment Agent Pool"
  DockerRegistry: "acr-connection"
  ResourceGroupName: "rg-hnx-staging-southeastasia"
  DockerRegistryURL: "crhnxswsoutheastasia.azurecr.io"
  environment: "staging"
  location: "southeastasia"
  repository: "swallet.managerservice"
  application: "SWallet.ManagerService"
  AppSettings: ".Projects/SWallet/Flow/SWallet.ManagerService"

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'

- script: |
    echo "$(environment)-appsettings"
    az storage blob download --container-name "$(environment)-appsettings" --name "$(application).appsettings.Development.json" --file "$(application).appsettings.Development.json" --account-name sthnxdevsoutheastasia --account-key $(storage_account_key)
    cp $(application).appsettings.Development.json "$(System.DefaultWorkingDirectory)/$(AppSettings)/appsettings.Development.json"
    cp $(application).appsettings.Development.json "$(System.DefaultWorkingDirectory)/$(AppSettings)/appsettings.json"
  displayName: "Replace $(application) AppSettings Files"

- task: Docker@2
  inputs:
    containerRegistry: 'acr-connection'
    repository: 'swallet.managerservice'
    command: 'buildAndPush'
    Dockerfile: '$(AppSettings)/Dockerfile'
    buildContext: '.'
    tags: |
      $(Build.BuildNumber)
      latest